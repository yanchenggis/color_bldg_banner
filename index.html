<script src='https://unpkg.com/@turf/turf@6/turf.min.js'></script>
<script>
    let hoveredBlock = null;

    map.on('load', () => {
        // Grey 3D buildings
        map.addLayer({
            'id': '3d-buildings',
            'source': 'openmaptiles',
            'source-layer': 'building',
            'type': 'fill-extrusion',
            'minzoom': 13,
            'paint': {
                'fill-extrusion-color': [
                    'case',
                    ['boolean', ['feature-state', 'highlighted'], false],
                    '#FF6B6B', // highlighted color
                    '#555555'  // default grey
                ],
                'fill-extrusion-height': ['get', 'render_height'],
                'fill-extrusion-base': ['get', 'render_min_height'],
                'fill-extrusion-opacity': 0.9
            }
        });

        loadShapefileFromGitHub();
    });

    async function loadShapefileFromGitHub() {
        const response = await fetch('https://raw.githubusercontent.com/yanchenggis/color_bldg_banner/main/precinct.zip');
        const arrayBuffer = await response.arrayBuffer();
        const geojson = await shp(arrayBuffer);
        addBoundariesToMap(geojson);
    }

    function addBoundariesToMap(geojson) {
        map.addSource('precincts', { type: 'geojson', data: geojson });

        map.addLayer({
            'id': 'precinct-fill',
            'type': 'fill',
            'source': 'precincts',
            'paint': { 'fill-color': '#0F5DF4', 'fill-opacity': 0 }
        });

        // Hover interaction
        map.on('mousemove', 'precinct-fill', (e) => {
            if (!e.features.length) return;

            const feature = e.features[0];
            const block = feature.properties.Block;

            if (hoveredBlock !== block) {
                hoveredBlock = block;

                // Reset all building states
                resetBuildingStates();

                // Highlight buildings inside this polygon
                highlightBuildings(feature);
            }
        });

        map.on('mouseleave', 'precinct-fill', () => {
            resetBuildingStates();
            hoveredBlock = null;
        });
    }

    function resetBuildingStates() {
        // Reset all building highlights
        const features = map.queryRenderedFeatures({ layers: ['3d-buildings'] });
        for (const f of features) {
            map.setFeatureState({ source: 'openmaptiles', sourceLayer: 'building', id: f.id }, { highlighted: false });
        }
    }

    function highlightBuildings(precinctFeature) {
        const poly = precinctFeature.geometry;
        const buildings = map.queryRenderedFeatures({ layers: ['3d-buildings'] });

        for (const b of buildings) {
            if (turf.booleanIntersects(b.geometry, poly)) {
                map.setFeatureState({ source: 'openmaptiles', sourceLayer: 'building', id: b.id }, { highlighted: true });
            }
        }
    }
</script>
