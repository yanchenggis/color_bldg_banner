<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Warisan KL Interactive Precincts</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src='https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js'></script>
  <link href='https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css' rel='stylesheet' />
  <script src="https://unpkg.com/shpjs@latest/dist/shp.js"></script>
  <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
  <style>
    body { margin: 0; padding: 0; background: #1a1a1a; }
    .banner-container { width: 100%; height: 90vh; min-height: 600px; position: relative; overflow: hidden; }
    #map { position: absolute; top: 0; bottom: 0; width: 100%; height: 100%; }
    .legend {
      position: absolute;
      bottom: 20px;
      right: 20px;
      background: rgba(255,255,255,0.9);
      padding: 10px;
      font-family: Arial, sans-serif;
      font-size: 13px;
      border-radius: 6px;
      box-shadow: 0 0 6px rgba(0,0,0,0.3);
      max-width: 200px;
    }
    .legend h4 { margin: 0 0 6px; font-size: 14px; }
    .legend div { display: flex; align-items: center; margin-bottom: 4px; }
    .legend span {
      display: inline-block;
      width: 14px; height: 14px;
      margin-right: 6px; border: 1px solid #555;
    }
  </style>
</head>
<body>
  <div class="banner-container">
    <div id="map"></div>
    <div class="legend" id="legend"></div>
  </div>

<script>
const map = new maplibregl.Map({
  container: 'map',
  style: 'https://tiles.openfreemap.org/styles/dark',
  center: [101.6941, 3.1500],
  zoom: 15,
  pitch: 55,
  bearing: 0,
  maxBounds: [[101.680, 3.135], [101.715, 3.165]]
});

// Building use colors
const landuseColors = {
  'Residential': '#FF6B6B',
  'Commercial': '#4ECDC4',
  'Institutional': '#FFD93D',
  'Industrial': '#C77DFF',
  'Recreation': '#A8E6CF'
};
const defaultBuildingColor = '#999999';

// Block highlight colors
const blockColors = ['#FF8C00','#1E90FF','#32CD32','#FF1493','#FFD700'];

let precinctsGeoJSON = null;
let enrichedBuildings = null;

map.on('load', async () => {
  // Load precincts and lucsa_bus_ polygons
  await loadData();

  // Get OSM building features (with render_height)
  const osmBuildings = map.querySourceFeatures('openmaptiles', {sourceLayer: 'building'});

  // Enrich your building polygons with OSM height
  enrichedBuildings = joinHeightsWithOSM(osmBuildings);

  // Add sources/layers
  addLayers();
  buildLegend();
});

async function loadData() {
  // Load precincts
  const resPrecinct = await fetch('https://raw.githubusercontent.com/yanchenggis/color_bldg_banner/main/precinct.zip');
  const bufPrecinct = await resPrecinct.arrayBuffer();
  precinctsGeoJSON = await shp(bufPrecinct);
  precinctsGeoJSON.features.forEach((f,i)=> f.properties._color = blockColors[i % blockColors.length]);

  // Load buildings
  const resBldg = await fetch('https://raw.githubusercontent.com/yanchenggis/color_bldg_banner/main/KLCCD_core_building_processed.zip');
  const bufBldg = await resBldg.arrayBuffer();
  enrichedBuildings = await shp(bufBldg);
}

function joinHeightsWithOSM(osmFeatures) {
  for (let feat of enrichedBuildings.features) {
    let height = 20; // fallback
    for (let osm of osmFeatures) {
      if (turf.booleanIntersects(feat.geometry, osm.geometry)) {
        height = osm.properties.render_height || height;
        break;
      }
    }
    feat.properties._height = height;
  }
  return enrichedBuildings;
}

function addLayers() {
  // Precincts
  map.addSource('precincts',{type:'geojson',data:precinctsGeoJSON});
  map.addLayer({
    id:'precinct-fill',
    type:'fill',
    source:'precincts',
    paint:{'fill-color':'#000','fill-opacity':0} // invisible
  });

  // Enriched 3D buildings
  map.addSource('buildings',{type:'geojson',data:enrichedBuildings});
  map.addLayer({
    id:'building-3d',
    type:'fill-extrusion',
    source:'buildings',
    paint:{
      'fill-extrusion-color': [
        'match',
        ['get','lucsa_bus_'],
        ...Object.entries(landuseColors).flat(),
        defaultBuildingColor
      ],
      'fill-extrusion-height':['get','_height'],
      'fill-extrusion-base':0,
      'fill-extrusion-opacity':0.9
    }
  });

  // Hover interaction
  map.on('mousemove','precinct-fill',(e)=>{
    if(!e.features.length) return;
    const blockFeature = e.features[0];
    highlightBlock(blockFeature);
  });
  map.on('mouseleave','precinct-fill',()=>{
    resetBlocks();
    resetBuildings();
  });
}

function highlightBlock(blockFeature) {
  const poly = blockFeature.geometry;
  const blockColor = blockFeature.properties._color;

  // Highlight block fill
  map.setPaintProperty('precinct-fill','fill-color',[
    'case',
    ['==',['get','Block'],blockFeature.properties.Block],
    blockColor,'#000'
  ]);
  map.setPaintProperty('precinct-fill','fill-opacity',[
    'case',
    ['==',['get','Block'],blockFeature.properties.Block],
    0.2,0
  ]);

  // Color logic: inside Block → lucsa_bus_, outside → grey
  const expr = ['case'];
  for(const feat of enrichedBuildings.features){
    const inside = turf.booleanIntersects(feat.geometry,poly);
    if(inside){
      const lu = feat.properties.lucsa_bus_;
      const col = landuseColors[lu] || defaultBuildingColor;
      expr.push(['==',['get','lucsa_bus_'],lu],col);
    }
  }
  expr.push(defaultBuildingColor);

  map.setPaintProperty('building-3d','fill-extrusion-color',expr);
}

function resetBlocks(){
  map.setPaintProperty('precinct-fill','fill-opacity',0);
}

function resetBuildings(){
  map.setPaintProperty('building-3d','fill-extrusion-color',[
    'match',
    ['get','lucsa_bus_'],
    ...Object.entries(landuseColors).flat(),
    defaultBuildingColor
  ]);
}

function buildLegend() {
  const legend = document.getElementById('legend');
  legend.innerHTML = '<h4>Legend</h4>';

  legend.innerHTML += '<strong>Building Use</strong><br>';
  for(const [k,v] of Object.entries(landuseColors)){
    legend.innerHTML += `<div><span style="background:${v}"></span>${k}</div>`;
  }

  legend.innerHTML += '<br><strong>Block Highlight</strong><br>';
  blockColors.forEach((c,i)=>{
    legend.innerHTML += `<div><span style="background:${c}"></span>Block ${i+1}</div>`;
  });
}
</script>
</body>
</html>
