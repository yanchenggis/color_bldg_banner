<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Warisan KL â€” Lucsa 3D + Blocks</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
  <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />
  <script src="https://unpkg.com/shpjs@latest/dist/shp.js"></script>
  <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
  <style>
    body { margin:0; padding:0; background:#111; font-family: Arial, Helvetica, sans-serif; }
    #map { position:fixed; inset:0; }
    .legend {
      position: absolute;
      bottom: 16px;
      right: 16px;
      z-index: 999;
      background: rgba(255,255,255,0.95);
      padding: 10px;
      border-radius: 6px;
      font-size:13px;
      color:#111;
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
      max-width:240px;
    }
    .legend h4 { margin:0 0 6px 0; font-size:14px; }
    .legend .row { display:flex; align-items:center; margin:4px 0; }
    .legend .swatch { width:14px; height:14px; margin-right:8px; border:1px solid #777; }
  </style>
</head>
<body>
<div id="map"></div>
<div class="legend" id="legend"></div>

<script>
/* ---------- CONFIG ---------- */
const PRECINCT_ZIP_URL = 'https://raw.githubusercontent.com/yanchenggis/color_bldg_banner/main/precinct.zip';
const BUILDING_ZIP_URL = 'https://raw.githubusercontent.com/yanchenggis/color_bldg_banner/main/KLCCD_core_building_processed.zip';

/* Lucsa pastel colors */
const lucsaColors = {
  'Residential': '#FFD3B6',
  'Commercial': '#FFAAA5',
  'Institutional': '#A8E6CF',
  'Industrial': '#D0BAFF',
  'Recreation': '#FFFFB5'
};
const defaultLucsaColor = '#CFCFCF';

/* Block highlight palette (bright) */
const blockHighlightPalette = ['#E41A1C','#377EB8','#4DAF4A','#984EA3','#FF7F00','#FFFF33','#A65628'];

/* ---------- Map Init ---------- */
const map = new maplibregl.Map({
  container: 'map',
  style: 'https://tiles.openfreemap.org/styles/dark',
  center: [101.6941, 3.1500],
  zoom: 15,
  pitch: 55,
  bearing: 0
});

let precincts = null;
let lucsaBuildings = null;
let blockToFeatureIndices = {};
let lucsaCategories = [];
let lucsaMatchExpression = null;

map.on('load', async () => {
  await waitForIdle();

  // 1) OSM 3D grey buildings
  map.addLayer({
    id: 'osm-3d-base',
    type: 'fill-extrusion',
    source: 'openmaptiles',
    'source-layer': 'building',
    paint: {
      'fill-extrusion-color': '#555555',
      'fill-extrusion-height': ['get','render_height'],
      'fill-extrusion-base': ['get','render_min_height'],
      'fill-extrusion-opacity': 0.9
    }
  });

  // 2) Load shapefiles
  precincts = await loadShapefileAsGeoJSON(PRECINCT_ZIP_URL);
  precincts.features.forEach((f,i)=> {
    if(!('Block' in f.properties)) f.properties.Block = String(i);
    f.properties._color = blockHighlightPalette[i % blockHighlightPalette.length];
  });

  lucsaBuildings = await loadShapefileAsGeoJSON(BUILDING_ZIP_URL);
  lucsaBuildings.features.forEach((f,i)=> {
    if(!('Lucsa' in f.properties)) f.properties.Lucsa = 'Unknown';
    f.properties.__index = i;
    f.properties.inBlock = true;
  });

  // categories
  lucsaCategories = Array.from(new Set(lucsaBuildings.features.map(f => f.properties.Lucsa || 'Unknown')));
  lucsaMatchExpression = buildMatchExpression(lucsaCategories);

  // join heights from OSM
  const osmFeatures = map.querySourceFeatures('openmaptiles',{sourceLayer:'building'})||[];
  joinHeightsClientSide(lucsaBuildings, osmFeatures);

  // spatial index
  buildBlockToFeaturesIndex(precincts, lucsaBuildings);

  // add layers
  addLucsaLayer();
  addPrecinctLayer();

  setupHoverHandlers();
  buildLegend();
});

/* ---------- Helpers ---------- */
function waitForIdle(){
  return new Promise(res=>{
    if(map.loaded()&&map.isStyleLoaded()) map.once('idle',()=>res());
    else map.once('load',()=>map.once('idle',()=>res()));
  });
}

async function loadShapefileAsGeoJSON(url){
  const r = await fetch(url);
  const arr = await r.arrayBuffer();
  const geo = await shp(arr);
  if(geo.type==='FeatureCollection') return geo;
  for(const k of Object.keys(geo)){ if(geo[k].type==='FeatureCollection') return geo[k]; }
  throw new Error('Bad shapefile '+url);
}

function buildMatchExpression(categories){
  const expr = ['match',['get','Lucsa']];
  for(const c of categories){
    expr.push(c, lucsaColors[c] || defaultLucsaColor);
  }
  expr.push(defaultLucsaColor);
  return expr;
}

function joinHeightsClientSide(lucsaGeo, osmFeatures){
  const osmIndex = osmFeatures.map(f=>({bbox:turf.bbox(f.geometry),feature:f}));
  for(const lb of lucsaGeo.features){
    let assigned=12;
    const bb = turf.bbox(lb.geometry);
    for(const item of osmIndex){
      if(item.bbox[0]>bb[2]||item.bbox[2]<bb[0]||item.bbox[1]>bb[3]||item.bbox[3]<bb[1]) continue;
      try{
        if(turf.booleanIntersects(lb.geometry,item.feature.geometry)){
          const h=item.feature.properties&&item.feature.properties.render_height;
          if(h&&!isNaN(Number(h))){assigned=Number(h);break;}
        }
      }catch{}
    }
    lb.properties._height=assigned;
  }
}

function buildBlockToFeaturesIndex(precinctsGeo, lucsaGeo){
  blockToFeatureIndices={};
  const lucsaBboxes = lucsaGeo.features.map(f=>turf.bbox(f.geometry));
  for(const block of precinctsGeo.features){
    const blockId=block.properties.Block;
    blockToFeatureIndices[blockId]=[];
    const bb=turf.bbox(block.geometry);
    for(let i=0;i<lucsaGeo.features.length;i++){
      const lb=lucsaBboxes[i];
      if(lb[0]>bb[2]||lb[2]<bb[0]||lb[1]>bb[3]||lb[3]<bb[1]) continue;
      try{ if(turf.booleanIntersects(block.geometry,lucsaGeo.features[i].geometry)) blockToFeatureIndices[blockId].push(i);}catch{}
    }
  }
}

function addLucsaLayer(){
  map.addSource('lucsa-buildings',{type:'geojson',data:lucsaBuildings});
  map.addLayer({
    id:'lucsa-buildings-3d',
    type:'fill-extrusion',
    source:'lucsa-buildings',
    paint:{
      'fill-extrusion-color':[
        'case',
        ['==',['get','inBlock'],true],
        lucsaMatchExpression,
        '#d0d0d0'
      ],
      'fill-extrusion-height':['get','_height'],
      'fill-extrusion-base':0,
      'fill-extrusion-opacity':0.95
    }
  });
}

function addPrecinctLayer(){
  map.addSource('precincts',{type:'geojson',data:precincts});
  map.addLayer({
    id:'precinct-hover-hit',
    type:'fill',
    source:'precincts',
    paint:{'fill-color':'#000','fill-opacity':0}
  });
  map.addLayer({
    id:'precinct-highlight',
    type:'fill',
    source:'precincts',
    paint:{'fill-color':['get','_color'],'fill-opacity':0.25},
    filter:['==',['get','Block'],'__none__']
  });
  map.addLayer({
    id:'precinct-outline',
    type:'line',
    source:'precincts',
    paint:{'line-color':'#fff','line-width':1.2,'line-opacity':0.5}
  });
}

function setupHoverHandlers(){
  map.on('mousemove','precinct-hover-hit',(e)=>{
    if(!e.features||!e.features.length)return;
    const block=e.features[0].properties.Block;
    map.setFilter('precinct-highlight',['==',['get','Block'],block]);
    const indicesIn=new Set(blockToFeatureIndices[block]||[]);
    for(let i=0;i<lucsaBuildings.features.length;i++){
      lucsaBuildings.features[i].properties.inBlock=indicesIn.has(i);
    }
    map.getSource('lucsa-buildings').setData(lucsaBuildings);
  });
  map.on('mouseleave','precinct-hover-hit',()=>{
    map.setFilter('precinct-highlight',['==',['get','Block'],'__none__']);
    for(const f of lucsaBuildings.features) f.properties.inBlock=true;
    map.getSource('lucsa-buildings').setData(lucsaBuildings);
  });
}

function buildLegend(){
  const legend=document.getElementById('legend');
  legend.innerHTML='<h4>Legend</h4>';
  legend.innerHTML+='<div style="font-weight:600;margin-top:6px;">Building classes (Lucsa)</div>';
  for(const [k,v] of Object.entries(lucsaColors)){
    legend.innerHTML+=`<div class="row"><div class="swatch" style="background:${v}"></div><div>${k}</div></div>`;
  }
  legend.innerHTML+='<div style="font-weight:600;margin-top:8px;">Block highlight (on hover)</div>';
  for(const f of precincts.features){
    legend.innerHTML+=`<div class="row"><div class="swatch" style="background:${f.properties._color}"></div><div>Block ${f.properties.Block}</div></div>`;
  }
}
</script>
</body>
</html>
