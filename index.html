<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Warisan KL Urban Analytics</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src='https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js'></script>
  <link href='https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css' rel='stylesheet' />
  <style>
    body { margin:0; padding:0; background:#1a1a1a; }
    .banner-container { width:100%; height:80vh; min-height:600px; position:relative; overflow:hidden;
        background:linear-gradient(135deg, rgba(15,93,244,1) 19%, rgba(33,200,117,1) 89%); }
    #map { position:absolute; top:0; bottom:0; width:100%; height:100%; }
    .content-overlay { position:absolute; top:75%; left:50px; transform:translateY(-50%);
        color:white; z-index:10; pointer-events:none; }
    .title { font-size:4em; font-weight:bold; margin-bottom:15px; text-shadow:3px 3px 8px rgba(0,0,0,0.7);
        font-family:Arial,sans-serif; }
    .subtitle { font-size:1.5em; opacity:0.9; text-shadow:2px 2px 6px rgba(0,0,0,0.7);
        font-family:Arial,sans-serif; }
    .legend { position:absolute; bottom:20px; right:20px; background:rgba(26,26,26,0.9); padding:12px;
        border-radius:8px; font-family:Arial,sans-serif; font-size:12px; color:white; }
    .legend h4 { margin:0 0 8px; font-size:13px; }
    .legend div { display:flex; align-items:center; margin-bottom:6px; }
    .legend span { display:inline-block; width:16px; height:16px; margin-right:8px; border-radius:3px; }
  </style>
</head>
<body>
<div class="banner-container">
  <div id="map"></div>
  <div class="content-overlay">
    <div class="title">Urban Analytics</div>
    <div class="subtitle">From Understanding Data to Developing Insights</div>
  </div>
  <div id="legend" class="legend"></div>
</div>

<script src="https://unpkg.com/shpjs@latest/dist/shp.js"></script>
<script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
<script>
const map = new maplibregl.Map({
  container:'map',
  style:'https://tiles.openfreemap.org/styles/dark',
  center:[101.6941,3.1500],
  zoom:14,
  pitch:55,
  bearing:0,
  maxBounds:[[101.680,3.135],[101.715,3.165]]
});

// palettes
const blockColors = ['#FF6B6B','#4ECDC4','#FFD93D','#A8E6CF','#C77DFF'];
// legend mapping (rename here)
const mainEntitColors = {
  "Government":"#FF6B6B",
  "Commercial":"#4ECDC4",
  "Cultural":"#FFD93D",
  "Education":"#C77DFF",
  "Religious":"#A8E6CF"
};

let hoveredBlock = null;

map.on('load',()=>{
  // OSM 3D grey
  map.addLayer({
    'id':'osm-3d',
    'source':'openmaptiles',
    'source-layer':'building',
    'type':'fill-extrusion',
    'minzoom':13,
    'paint':{
      'fill-extrusion-color':'#555555',
      'fill-extrusion-height':['get','render_height'],
      'fill-extrusion-base':['get','render_min_height'],
      'fill-extrusion-opacity':0.7
    }
  });

  loadPrecincts();
  loadBuildings();
});

async function loadPrecincts(){
  const res = await fetch('https://raw.githubusercontent.com/yanchenggis/color_bldg_banner/main/precinct.zip');
  const buf = await res.arrayBuffer();
  const precincts = await shp(buf);
  precincts.features.forEach((f,i)=>f.id=i);

  map.addSource('precincts',{type:'geojson',data:precincts});
  map.addLayer({
    id:'precinct-outline',
    type:'line',
    source:'precincts',
    paint:{'line-color':'#fff','line-width':2}
  });
  map.addLayer({
    id:'precinct-fill',
    type:'fill',
    source:'precincts',
    paint:{'fill-color':'#000','fill-opacity':0}
  });
  map.addLayer({
    id:'precinct-highlight',
    type:'fill',
    source:'precincts',
    paint:{
      'fill-color':['case',
        ['boolean',['feature-state','hover'],false],
        ['get','color'],
        '#000'
      ],
      'fill-opacity':0.3
    }
  });

  map.on('mousemove','precinct-fill',e=>{
    if(e.features.length>0){
      if(hoveredBlock!==null){
        map.setFeatureState({source:'precincts',id:hoveredBlock},{hover:false});
      }
      hoveredBlock=e.features[0].id;
      e.features[0].properties.color=blockColors[hoveredBlock%blockColors.length];
      map.setFeatureState({source:'precincts',id:hoveredBlock},{hover:true});
      updateBuildingsInBlock(e.features[0]);
    }
  });

  map.on('mouseleave','precinct-fill',()=>{
    if(hoveredBlock!==null){
      map.setFeatureState({source:'precincts',id:hoveredBlock},{hover:false});
      hoveredBlock=null;
    }
    resetBuildings();
  });
}

async function loadBuildings(){
  const res = await fetch('https://raw.githubusercontent.com/yanchenggis/color_bldg_banner/main/KLCCD_core_building_processed.zip');
  const buf = await res.arrayBuffer();
  const bldg = await shp(buf);
  map.addSource('custom-buildings',{type:'geojson',data:bldg});

  map.addLayer({
    id:'custom-buildings',
    type:'fill-extrusion',
    source:'custom-buildings',
    paint:{
      'fill-extrusion-color':'#555555',
      'fill-extrusion-height':['get','render_height'],
      'fill-extrusion-base':['get','render_min_height'],
      'fill-extrusion-opacity':0.95
    }
  });

  buildLegend();
}

function updateBuildingsInBlock(blockFeature){
  const geom = blockFeature.geometry;
  map.setPaintProperty('custom-buildings','fill-extrusion-color',[
    'case',
    ['within',geom],
    ['match',['get','main_entit'],
      ...Object.entries(mainEntitColors).flat(),
      '#888'
    ],
    '#555555'
  ]);
}

function resetBuildings(){
  map.setPaintProperty('custom-buildings','fill-extrusion-color','#555555');
}

function buildLegend(){
  const legend=document.getElementById('legend');
  legend.innerHTML='<h4>Main Entity</h4>';
  for(const [k,v] of Object.entries(mainEntitColors)){
    const div=document.createElement('div');
    div.innerHTML=`<span style="background:${v}"></span>${k}`;
    legend.appendChild(div);
  }
}
</script>
</body>
</html>
